# BE-042：LaTeX ZIPの安全展開（zip-slip対策/許可拡張子制限）

## 担当者
- 

## 目的
LaTeX ZIP を安全に展開し、抽出処理が読める作業ディレクトリを作る。

## 全体像
- `./D-WORKER-OVERVIEW.md` を参照（extract の位置づけ）

## 型定義との整合（commit: `3a13f165b4574583b10a8c1a3b608ee9eb9ba371` 反映）
- 対象は `Submission.inputType === InputType.LATEX_ZIP` のときのみ実行
- `Submission.gcsPathRaw` を入力ソースとして扱う

## どこから呼ばれる前提か（Entry）
- orchestrator の extract ステップ内で呼ばれる（BE-040 からのチェーン）
- 典型: safe unzip（BE-042）→ latex extract（BE-043）

## 完了条件（Definition of Done）
- zip-slip（`../` など）を防止できる
- 許可拡張子のみ展開できる
- 展開先ディレクトリ固定（`/tmp/analysis/{analysisId}`）
- 最大ファイル数・最大総サイズを超えたら中断できる

## 実装対象ファイル
- `src/services/extract/latex.extractor.ts`
- （必要なら）`src/utils/security.ts`

## セキュリティ要件
### パス検証
- entry path が絶対パスなら拒否
- `..` を含む相対移動を拒否
- `path.resolve(baseDir, entryPath)` が `baseDir` 配下であることを確認

### 拡張子ホワイトリスト（初期案）
- テキスト系: `.tex`, `.bib`, `.bst`, `.cls`, `.sty`, `.txt`
- 画像系: `.png`, `.jpg`, `.jpeg`, `.pdf`, `.eps`
- 補助系: `.csv`

### 制限値（初期案）
- 最大ファイル数: 2,000
- 最大総展開サイズ: 200MB
- 1ファイル最大: 20MB

## API（Extractor 内部）
```ts
type ExpandedLatexProject = {
  rootDir: string
  entryTexCandidates: string[]
  extractedFiles: string[]
}

async function safeUnzipLatex(
  zipBuffer: Buffer,
  analysisId: string
): Promise<ExpandedLatexProject>
```

## 実装手順
1. 一時展開先 `tmpRoot = /tmp/analysis/{analysisId}` を作成
2. ZIP を走査し、各 entry に対して path と拡張子を検証
3. 制限値をカウントしながら展開
4. `.tex` ファイル一覧を収集して返す
5. 失敗時はディレクトリを削除（best effort）

## 注意
- Node 標準だけで ZIP を安全処理しづらいので、`yauzl` / `unzipper` などの採用を検討
- シンボリックリンク entry は拒否する

## 失敗時エラーコード案
- `INVALID_ZIP_PATH`
- `DISALLOWED_FILE_TYPE`
- `ZIP_TOO_LARGE`
- `ZIP_TOO_MANY_FILES`
- `ZIP_CORRUPTED`

## テスト観点
- `../evil.tex` を含む ZIP が拒否される
- 許可外拡張子（`.exe`）が拒否される
- 上限超過で中断される
- 正常 ZIP で `.tex` 候補が返る

## 作業ログ
- 

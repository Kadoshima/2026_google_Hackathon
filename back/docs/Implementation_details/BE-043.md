# BE-043：LatexExtractor（sections/paragraphs/figures/citations 最小抽出）

## 担当者
- 

## 目的
LaTeX 原稿から、後段解析で使える最小構造データ（sections/paragraphs/figures/citations）を安定して抽出する。

## 全体像
- `./D-WORKER-OVERVIEW.md` を参照（extract JSON が BE-045 で保存される）

## 型定義との整合（commit: `3a13f165b4574583b10a8c1a3b608ee9eb9ba371` 反映）
- 生成した `paragraphId` / `figureId` / `citationKey` は、後段の `ConversationRefs`（`paragraphIds`, `figureIds`, `citationKeys`）で参照される前提で一貫した命名にする
- `analysisId` は `Analysis.analysisId` を使って trace する

## どこから呼ばれる前提か（Entry）
- orchestrator の extract ステップ内（LaTeX ZIP 分岐）で呼ばれる
- 直前に BE-042（safe unzip）で作った作業ディレクトリを入力にする

## 完了条件（Definition of Done）
- 入力 `.tex` 群から `ExtractJson` 相当データを生成できる
- 段落ごとに一意な `paragraphId` を付与できる
- `section` / `figure` / `citation` の最低限情報を抽出できる
- 壊れた LaTeX でも全体失敗せず、可能な範囲で抽出できる

## 実装対象ファイル
- `src/services/extract/latex.extractor.ts`
- `src/services/extract/normalize.ts`

## 最小抽出仕様
### sections
- 対象コマンド: `\section`, `\subsection`, `\subsubsection`
- 出力: `id`, `title`, `level`

### paragraphs
- セクション内テキストを空行区切りで段落化
- 出力: `id`, `sectionId`, `text`
- `id` 形式例: `p_0001`, `p_0002`

### figures
- 対象: `\begin{figure} ... \end{figure}`
- 出力: `id`, `label`, `caption`, `mentionedInParagraphIds`
- `\label{fig:xxx}` があれば `label` に保存

### citations
- 本文中 `\cite{a,b,c}` 系を抽出（`\citep`, `\citet` も正規表現で対応）
- 出力: `inTextCites[]` に `{ paragraphId, keys[] }`
- `.bib` から `@article{key, ...}` の `key` 一覧を抽出し `bibEntries[]` に格納

## 実装ステップ
1. BE-042 の展開結果から entry `.tex` を決定（優先: `main.tex`）
2. `\input{}` / `\include{}` の最小展開（まずは1段だけで可）
3. コメント除去（`%` 以降）と改行正規化
4. section 抽出
5. figure 抽出
6. citation 抽出
7. 段落化と paragraphId 採番
8. `ExtractJson` へ整形

## 正規表現の初期案
- section: `\\(subsubsection|subsection|section)\{([^}]*)\}`
- figure block: `\\begin\{figure\}[\s\S]*?\\end\{figure\}`
- label: `\\label\{([^}]*)\}`
- caption: `\\caption\{([^}]*)\}`
- cite: `\\cite[t|p]?\{([^}]*)\}`

## 例外許容ポリシー
- 解析不能なブロックはスキップして継続
- 1件も抽出できなくても `paragraphs` は空配列で返す（throw しない）
- 重大障害（ZIP読込不可など）のみ throw

## テスト観点
- 標準的な `main.tex` で4要素が抽出される
- `\cite{a,b}` が2キーとして分解される
- 図表ラベルなしでも figure として抽出される
- セクションなし文書でも paragraph は抽出される

## 作業ログ
- 

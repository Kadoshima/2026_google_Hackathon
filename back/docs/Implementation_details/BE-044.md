# BE-044：PdfExtractor（ベータ：テキスト抽出＋段落分割）

## 担当者
- 

## 目的
PDF 入力に対して、最低限のテキスト抽出と段落分割を行い、LaTeX 入力と同じ後段 I/F で扱えるようにする。

## 全体像
- `./D-WORKER-OVERVIEW.md` を参照（PDF 分岐でも最終的に BE-045 へ出力）

## 型定義との整合（commit: `3a13f165b4574583b10a8c1a3b608ee9eb9ba371` 反映）
- 対象は `Submission.inputType === InputType.PDF`
- 出力の `paragraphId` / `citationKey` は `ConversationRefs` で参照される形式に揃える

## どこから呼ばれる前提か（Entry）
- orchestrator の extract ステップ内（PDF 分岐）で呼ばれる
- 入力 PDF は `Submission.gcsPathRaw` から取得する前提

## 完了条件（Definition of Done）
- PDF からプレーンテキストを取り出せる
- 段落単位で `paragraphId` を付与できる
- section/figure/citation は空でもよいが、`ExtractJson` として返せる
- 失敗時のフォールバック挙動（warning 付き空抽出）が決まっている

## 実装対象ファイル
- `src/services/extract/pdf.extractor.ts`
- `src/services/extract/normalize.ts`

## 依存ライブラリ方針
- 候補: `pdf-parse`（最小導入）
- 代替: 先に Not Implemented を返すのではなく、`paragraphs: []` + warning を返す

## 出力の最小仕様
```ts
{
  sections: [],
  paragraphs: [
    { id: 'p_0001', sectionId: null, text: '...' }
  ],
  figures: [],
  citations: {
    bibEntries: [],
    inTextCites: []
  },
  meta: {
    extractor: 'pdf-beta',
    warnings: string[]
  }
}
```

## 実装ステップ
1. PDF バイナリを読み込む
2. 抽出テキストを取得
3. 改行を正規化して段落分割
4. 段落 ID を連番採番
5. citation だけは簡易抽出（例: `[12]` / `(Smith, 2022)` の検出）してもよい
6. `ExtractJson` に整形

## 段落分割ルール（初期）
- 2回以上の連続改行で段落区切り
- 1行が極端に短いヘッダ/フッタは除外候補
- 空文字段落は除外

## 失敗時ポリシー
- 抽出失敗 = 例外 throw ではなく warning を積んで空配列返却（MVP安定優先）
- ただしファイル破損など致命的な入力不正は `INVALID_PDF` として throw

## テスト観点
- テキスト PDF で段落が抽出できる
- 画像だけの PDF で warning 付き空抽出になる
- 破損 PDF で `INVALID_PDF` になる

## 作業ログ
- 

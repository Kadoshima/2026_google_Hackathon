# BE-046：Preflight最小（参照漏れ：図表/引用）検出

## 担当者
- 

## 目的
抽出結果を使って、投稿前に致命的になりやすい参照漏れ（図表/引用）をルールベースで検出する。

## 全体像
- `./D-WORKER-OVERVIEW.md` を参照（extract → preflight → result 保存）

## 型定義との整合（commit: `3a13f165b4574583b10a8c1a3b608ee9eb9ba371` 反映）
- finding の `refs` は `ConversationRefs` と同じキー名を使う
  - `paragraphIds`
  - `claimIds`
  - `figureIds`
  - `citationKeys`
- 集計値を `AnalysisMetrics` に反映する場合は既存名（`noEvidenceClaimsCount`, `weakEvidenceClaimsCount`, `specificityLackCount`）を使う

## どこから呼ばれる前提か（Entry）
- orchestrator の extract 完了後に呼ばれる（BE-045 以降の想定）
- 出力は最終結果 JSON（例: `analysis/{analysisId}/result.json`）にマージされる

## 完了条件（Definition of Done）
- `ExtractJson` から preflight 結果を生成できる
- 図表参照漏れ・引用参照漏れを最低1種類ずつ検出できる
- 結果を後段で `analysis/result.json` に統合できるデータ構造で返せる

## 実装対象ファイル
- `src/services/analysis/orchestrator.ts`
- （必要なら）`src/services/analysis/preflight.ts`（新規）

## ルール（MVP最小）
### 図表
- `figures[].label` があるのに本文で `ref{label}` 相当が1回も出てこない
- 本文で `Fig.` / `Figure` + 番号参照があるのに、対応する figure が見つからない

### 引用
- `inTextCites.keys[]` にある key が `bibEntries.key` に存在しない
- `bibEntries` にある key が本文で一度も引用されない（warning）

## 出力スキーマ案
```ts
type PreflightFinding = {
  id: string
  kind:
    | 'MISSING_FIGURE_REFERENCE'
    | 'UNKNOWN_FIGURE_REFERENCE'
    | 'MISSING_BIB_ENTRY'
    | 'UNCITED_BIB_ENTRY'
  severity: 'error' | 'warning'
  message: string
  refs?: {
    paragraphIds?: string[]
    figureIds?: string[]
    citationKeys?: string[]
  }
}

type PreflightResult = {
  findings: PreflightFinding[]
  summary: {
    errorCount: number
    warningCount: number
  }
}
```

## 実装ステップ
1. `ExtractJson` を受ける `runPreflight(extract)` を実装
2. 図表ルールで findings 追加
3. 引用ルールで findings 追加
4. summary を集計
5. orchestrator で preflight を呼び、最終結果オブジェクトへマージ

## 疑似コード
```ts
const preflight = runPreflight(extract)
const result = {
  ...analysisResult,
  preflight
}
await storage.putJson(`analysis/${analysisId}/result.json`, result)
```

## 失敗時ポリシー
- preflight 処理エラーは解析全体を落とさず warning として吸収（MVP優先）
- ただし result 保存失敗は `FAILED`

## テスト観点
- 未参照 figure が `MISSING_FIGURE_REFERENCE` になる
- 未定義 citation key が `MISSING_BIB_ENTRY` になる
- 未使用 bib key が `UNCITED_BIB_ENTRY` になる
- findings が0件のとき summary が0になる

## 作業ログ
- 

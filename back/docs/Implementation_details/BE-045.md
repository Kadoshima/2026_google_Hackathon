# BE-045：ExtractJson仕様の確定＆GCS保存（extract/{analysisId}/extract.json）

## 担当者
- 

## 目的
抽出結果の共通スキーマを定義し、GCS に永続化して後続工程（LLM解析・Preflight）から再利用できるようにする。

## 全体像
- `./D-WORKER-OVERVIEW.md` を参照（extract JSON の保存位置と pointers 更新）

## 完了条件（Definition of Done）
- `ExtractJson` 型が `src/domain/types.ts`（または `src/domain/extract.ts`）で定義されている
- `extract/{analysisId}/extract.json` へ保存できる
- Firestore `analysis.pointers.gcsExtractJson` に GCS パスが保存される
- 抽出元（latex/pdf）によらず同一スキーマで保存できる

## 型定義との整合（commit: `3a13f165b4574583b10a8c1a3b608ee9eb9ba371` 反映）
- `AnalysisPointers` の既存フィールド名をそのまま使う
- `gcsExtractJson`（このタスクで更新）
- `gcsAnalysisJson`（後段結果保存で更新）
- `gcsReportHtml`（report 生成で更新）
- `analysisId` / `submissionId` / `sessionId` は `Analysis` 型の命名に合わせる

## どこから呼ばれる前提か（Entry）
- orchestrator の extract ステップの最後で呼ばれる
  - BE-043 または BE-044 の出力を `ExtractJson` として保存する

## 実装対象ファイル
- `src/domain/types.ts`
- `src/services/storage.service.ts`
- `src/services/firestore.repo.ts`
- `src/services/analysis/orchestrator.ts`

## 最小スキーマ案
```ts
type ExtractJson = {
  schemaVersion: 'v1'
  analysisId: string
  inputType: 'LATEX_ZIP' | 'PDF'
  sections: Array<{ id: string; title: string; level: number }>
  paragraphs: Array<{ id: string; sectionId: string | null; text: string }>
  figures: Array<{ id: string; label?: string; caption?: string; mentionedInParagraphIds: string[] }>
  citations: {
    bibEntries: Array<{ key: string; raw?: string }>
    inTextCites: Array<{ paragraphId: string; keys: string[] }>
  }
  meta?: {
    extractor: string
    warnings?: string[]
    createdAt: string
  }
}
```

## 保存先
- GCS key: `extract/{analysisId}/extract.json`

## 実装ステップ
1. `ExtractJson` 型を定義
2. `StorageService.putJson(path, object)` を実装
3. orchestrator の extract ステップで `putJson` を呼ぶ
4. `FirestoreRepo.setPointers(analysisId, { gcsExtractJson: ... })` を呼ぶ
5. status/progress を `EXTRACTING -> ANALYZING` へ更新

## 疑似コード
```ts
const extract = await extractor.extract(...)
const gcsPath = `extract/${analysisId}/extract.json`
await storage.putJson(gcsPath, extract)
await repo.setPointers(analysisId, { gcsExtractJson: gcsPath })
await repo.updateAnalysisStatus(analysisId, 'ANALYZING', 0.4, 'logic')
```

## バージョニング方針
- `schemaVersion` を必須化（将来互換のため）
- 破壊的変更時は `v2` を作り、reader 側で分岐

## テスト観点
- latex extractor 結果が `ExtractJson` として保存できる
- pdf extractor 結果が同じスキーマで保存できる
- pointers 更新後に `getAnalysis` で参照できる
- JSON 保存失敗時に `FAILED` へ遷移する

## 作業ログ
- 
